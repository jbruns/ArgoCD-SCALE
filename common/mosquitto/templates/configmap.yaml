{{- include "bjw-s.common.loader.init" . -}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "bjw-s.common.lib.chart.names.fullname" . }}-config
  labels:
    {{- include "bjw-s.common.lib.metadata.allLabels" . | nindent 4 }}
data:
  mosquitto.conf: |
    per_listener_settings {{ .Values.perListenerSettings }}
    {{- if .Values.addListener }}
    listener {{ .Values.service.main.ports.mqtt.port }}
    {{- end}}
    {{- if .Values.auth.enabled }}
    allow_anonymous false
    {{- else }}
    allow_anonymous true
    {{- end }}
    {{- if .Values.persistence.data.enabled }}
    persistence true
    {{- with (index .Values.persistence.data.globalMounts 0) }}
    persistence_location {{ .path }}
    {{- end }}
    autosave_interval 1800
    {{- end }}
    {{- if .Values.persistence.configinc.enabled }}
    {{- with (index .Values.persistence.configinc.globalMounts 0) }}
    include_dir {{ .path }}
    {{- end }}
    {{- end }}
